name: CI

on:
  push:
    branches:
      - main
      - master
      - 'codex/**'
  pull_request:

jobs:
  detect-native-changes:
    runs-on: ubuntu-latest
    outputs:
      ios: ${{ steps.filter.outputs.ios }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Detect iOS/native changes
        id: filter
        uses: dorny/paths-filter@v3
        with:
          filters: |
            ios:
              - 'ios/**'
              - 'app.config.ts'
              - 'package.json'
              - 'package-lock.json'
              - 'scripts/ios/**'
              - 'docs/ios-warning-policy.md'
              - 'docs/ios-warning-matrix.md'

  validate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check duplicate suffixed tracked files
        run: bash ./scripts/ci/check-duplicate-suffixed-files.sh

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Typecheck
        run: npm run typecheck

      - name: Lint
        run: npm run lint

      - name: Expo doctor
        run: npx expo-doctor

  ios-warning-audit:
    needs: detect-native-changes
    if: needs.detect-native-changes.outputs.ios == 'true'
    runs-on: macos-14
    timeout-minutes: 35
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Ensure CocoaPods 1.16.2
        run: |
          if ! command -v pod >/dev/null 2>&1; then
            sudo gem install cocoapods -v 1.16.2 --no-document
          fi
          current_pod_version="$(pod --version)"
          echo "Current CocoaPods version: $current_pod_version"
          if [ "$current_pod_version" != "1.16.2" ]; then
            sudo gem install cocoapods -v 1.16.2 --no-document
          fi
          final_pod_version="$(pod --version)"
          echo "Using CocoaPods version: $final_pod_version"
          if [ "$final_pod_version" != "1.16.2" ]; then
            echo "Failed to pin CocoaPods to 1.16.2"
            exit 1
          fi

      - name: Verify iOS warnings
        env:
          IOS_WARNING_AUDIT_POD_MODE: deployment
          IOS_WARNING_AUDIT_POD_RETRIES: '2'
          IOS_WARNING_AUDIT_POD_ALLOW_FALLBACK: '1'
          IOS_WARNING_AUDIT_POD_FALLBACK_MODE: repo-update
          IOS_WARNING_AUDIT_POD_FALLBACK_RETRIES: '1'
        run: npm run ios:verify-warnings

      - name: Show iOS warning diagnostics
        if: failure()
        run: |
          echo "=== report.md ==="
          sed -n '1,220p' artifacts/ios-warning-audit/report.md || true
          echo "=== unmatched-warnings.log ==="
          sed -n '1,120p' artifacts/ios-warning-audit/unmatched-warnings.log || true
          echo "=== pod-install-summary.txt ==="
          sed -n '1,120p' artifacts/ios-warning-audit/pod-install-summary.txt || true
          echo "=== pod-install.log (tail) ==="
          tail -n 200 artifacts/ios-warning-audit/pod-install.log || true

      - name: Upload iOS warning artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ios-warning-audit
          path: artifacts/ios-warning-audit
          if-no-files-found: ignore
